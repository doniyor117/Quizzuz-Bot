# AI Generate - Word Processing Handler
@router.message(AddCardStates.waiting_ai_words)
async def process_ai_words(message: types.Message, state: FSMContext):
    user = await get_user(message.from_user.id)
    lang = user['lang_code']
    
    words = [w.strip() for w in message.text.split('\n') if w.strip()]
    
    if not words:
        await message.answer("âŒ Please enter at least one word.")
        return
    
    # Show processing message
    processing_msg = await message.answer(f"ğŸ¤– Generating flashcards for {len(words)} word(s)...\nThis may take a moment.")
    
    # Generate cards for each word
    generated_cards = []
    failures = []
    
    for word in words:
        ai_content = await generate_card_content(word)
        
        if ai_content:
            # Create card with AI-generated content
            definition = ai_content.get('definition', '')
            translation = ai_content.get('translation', '')
            examples = ai_content.get('examples', [])
            
            # Combine definition and examples
            full_definition = definition
            if translation:
                full_definition += f"\n\nğŸ‡ºğŸ‡¿ {translation}"
            if examples:
                full_definition += "\n\nğŸ“ Examples:\n" + "\n".join(f"â€¢ {ex}" for ex in examples)
            
            generated_cards.append({'term': word, 'def': full_definition})
        else:
            failures.append(word)
    
    # Show results
    if not generated_cards:
        await processing_msg.edit_text(
            "âŒ Failed to generate cards.\n\n"
            "This might be due to:\n"
            "â€¢ Missing GROQ_API_KEY in environment\n"
            "â€¢ API rate limits\n"
            "â€¢ Network issues\n\n"
            "Try again later or use manual mode."
        )
        await state.clear()
        return
    
    # Save generated cards
    data = await state.get_data()
    set_name = data.get('set_name', 'AI Generated Set')
    user_id = message.from_user.id
    
    await create_set(user_id, None, set_name, False, generated_cards)
    
    # Award XP
    xp_earned = len(generated_cards) * 2.0  # 2 XP per AI-generated card
    await add_xp(user_id, xp_earned)
    
    # Show success message
    success_text = (
        f"âœ… Created {len(generated_cards)} flashcard(s)!\n"
        f"+{xp_earned} XP earned!\n\n"
        f"Set: '{set_name}'\n"
    )
    
    if failures:
        success_text += f"\nâš ï¸ Failed to generate: {', '.join(failures)}"
    
    success_text += "\n\nğŸ“š Practice your new cards anytime!"
    
    await processing_msg.edit_text(success_text)
    await state.clear()
